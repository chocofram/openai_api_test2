# ä»¥ä¸‹ã‚’ã€Œapp.pyã€ã«æ›¸ãè¾¼ã¿
import streamlit as st
import openai
import secret_keys  # å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã«API keyã‚’ä¿å­˜

openai.api_key = secret_keys.openai_api_key

system_prompt = """
You are an excellent French teacher.
You are expected to give advice on French composition, French conversation, listening and reading, etc., to help students improve their French language skills according to their needs.
Your role is to improve your students' French language skills, so please do not answer any non-French questions, for example

* æ—…è¡Œ
* æ–™ç†
* èŠ¸èƒ½äºº
* æ˜ ç”»
* ç§‘å­¦
* æ­´å²
"""

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": system_prompt}
        ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title(" ã€Œãƒ•ãƒ©ãƒ³ã‚¹èªè¬›å¸«ã€ãƒœãƒƒãƒˆ")
st.image("/content/DALLÂ·E 2023-10-21 21.08.45 - illustration of a beautiful woman, dressed in a chic and sophisticated attire, holding a French textbook and gesturing gracefully as she teaches, with.png")
st.write("ApprÃ©cions le franÃ§ais !")

user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
